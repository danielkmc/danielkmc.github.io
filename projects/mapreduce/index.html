<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>MapReduce | Daniel Chen</title> <meta name="author" content="Daniel Chen"> <meta name="description" content="An implementation of the MapReduce algorithm in Golang."> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/tennis_icon.png"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://danielkmc.github.io/projects/mapreduce/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Daniel </span>Chen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/resume/">resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">MapReduce</h1> <p class="post-description">An implementation of the MapReduce algorithm in Golang.</p> </header> <article> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/mapreduce-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/mapreduce-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/mapreduce-1400.webp"></source> <img src="/assets/img/mapreduce.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> <a href="https://matthewmacfarquhar.medium.com/mastering-mapreduce-a-step-by-step-java-tutorial-for-big-data-processing-47e1bd96d6e2" rel="external nofollow noopener" target="_blank">Image credit: Matthew MacFarquhar</a> </div> <p>Here is the <a href="https://github.com/danielkmc/MIT-6.5840/tree/main/src/mr" rel="external nofollow noopener" target="_blank">link</a> to the code implemented for this MapReduce implementation.</p> <p>Note: the original template of this codebase is based on and owned by <a href="https://pdos.csail.mit.edu/6.824/" rel="external nofollow noopener" target="_blank">MIT’s 6.5840 Distributed Systems course</a>.</p> <p>The directory contains the Golang implementation for the Worker and Coordinator (Master) service within MapReduce based on the <a href="http://static.googleusercontent.com/media/research.google.com/en//archive/mapreduce-osdi04.pdf" rel="external nofollow noopener" target="_blank">original paper</a> specifying the design.</p> <p>The application being transformed with MapReduce is a word counter found in <code class="language-plaintext highlighter-rouge">src/mrapps/wc.go</code></p> <p>There are three implemented files located in <code class="language-plaintext highlighter-rouge">src/mr</code>:</p> <ul> <li>rpc.go</li> <li>coordinator.go</li> <li>worker.go</li> </ul> <p>where <code class="language-plaintext highlighter-rouge">coordinator.go</code> and <code class="language-plaintext highlighter-rouge">worker.go</code> are called by <code class="language-plaintext highlighter-rouge">mrcoordinator.go</code> and <code class="language-plaintext highlighter-rouge">mrworker.go</code>, respectively, located in <code class="language-plaintext highlighter-rouge">src/main</code>.</p> <h2 id="components">Components</h2> <hr> <h3 id="rpcgo"><strong>rpc.go</strong></h3> <p>This file contains args and reply structs for the various RPCs implemented in coordinator.go. There are four different pairs of args/reply structs for the four different RPCs implemented:</p> <ul> <li>MapTask <ul> <li>Args <ul> <li>no fields are added here since the worker doesn’t need to provide any information to the coordinator when requesting a map task</li> </ul> </li> <li>Reply <ul> <li> <strong>Filename</strong> - file the map task needs to create key value pairs of the format {string, “1”} for each word</li> <li> <strong>NReduce</strong> - needed to distribute key-value pairs evenly for N reduce jobs. Used to mod hash output for distribution</li> <li> <strong>RemainingTasks</strong> - coordinator tells worker how many tasks are left and if it should wait before performing reduce tasks</li> <li> <strong>TaskNumber</strong> - used to organize intermediate output file names according to the map task</li> </ul> </li> </ul> </li> <li>Intermediate <ul> <li>Args <ul> <li> <strong>TaskNumber</strong> - used for worker to tell Coordinator which task it was assigned. If the Coordinator already has the output for that map task, it doesn’t do anything. Otherwise, it stores the intermediate files and records completion of the map task</li> <li> <strong>IntermediaryFiles</strong> - array of file names of the intermediate files that the map task produced for the Coordinator to store</li> </ul> </li> <li>Reply <ul> <li>No entries since there is no information to pass to worker</li> </ul> </li> </ul> </li> <li>ReduceTask <ul> <li>Args <ul> <li>No entries since worker is a resource to the Coordinator to use</li> </ul> </li> <li>Reply <ul> <li> <strong>TaskNumber</strong> - used for worker to correctly name output of reduce function file</li> <li> <strong>IntermediateFiles</strong> - intermediate files produced by map function for worker to reduce</li> <li> <strong>RemainingTasks</strong> - used to indicate if worker should wait for more tasks or exit</li> </ul> </li> </ul> </li> <li>ReduceCompletion <ul> <li>Args <ul> <li> <strong>TaskNumber</strong> - used to tell Coordinator that this reduce task number completed</li> </ul> </li> <li>Reply <ul> <li>No entries since worker will request in separate RPC for new task</li> </ul> </li> </ul> </li> </ul> <hr> <h3 id="coordinatorgo"><strong>coordinator.go</strong></h3> <p>This file contains implementation details for the various RPCs needed to perform MapReduce.</p> <p>RPCs include:</p> <ul> <li> <strong>GetMapTask</strong> - Coordinator provides Worker request details to perform an available map task or tells the Worker to sleep if all the tasks are assigned but may not have been completed.</li> <li> <strong>StoreIntermediateFiles</strong> - Coordinator stores intermediate files produced by map task completed by Worker</li> <li> <strong>GetReduceTask</strong> - Coordinator provides Worker.intermediate files to perform reduce task or tells Worker to sleep if all tasks are assigned but have not completed.</li> <li> <strong>CompleteReduceTask</strong> - Coordinator takes <strong>TaskNumber</strong> provided by Worker to mark the reduce tasks as completed.</li> </ul> <p>The coordinator contains a <strong>Coordinator</strong> struct with various information used to track the state for the MapReduce operation being performed, all initialized in the <strong>MakeCoordinator</strong> function within this file:</p> <div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Coordinator</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">inputFiles</span>           <span class="p">[]</span><span class="kt">string</span>       <span class="c">// stores input files provided</span>
	<span class="n">mapStartTimes</span>        <span class="p">[]</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span>    <span class="c">// stores start times (task time limit 10s)</span>
	<span class="n">mapMu</span>                <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>     <span class="c">// protects the inputFiles, mapStartTimes</span>
	<span class="n">mapBool</span>              <span class="p">[]</span><span class="kt">bool</span>         <span class="c">// stores completion status of task</span>
	<span class="n">remainingMapTasks</span>    <span class="kt">int</span>            <span class="c">// stores number of incomplete Map tasks</span>
	<span class="n">intermediaryFiles</span>    <span class="p">[][]</span><span class="kt">string</span>     <span class="c">// [i][j] refers to the jth map reduce output, ith reduce task</span>
	<span class="n">intermediateMu</span>       <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>     <span class="c">// protects mapBool, remainingMapTasks, intermediaryFiles</span>
	<span class="n">reduceStartTimes</span>     <span class="p">[]</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span>    <span class="c">// reduce tasks' start times (max 10s)</span>
	<span class="n">reduceBool</span>           <span class="p">[]</span><span class="kt">bool</span>         <span class="c">// reduce tasks' completion status</span>
	<span class="n">remainingReduceTasks</span> <span class="kt">int</span>            <span class="c">// number of incomplete reduce tasks</span>
	<span class="n">reduceMu</span>             <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>     <span class="c">// protects reduceStartTimes, reduceBool, remainingReduceTasks</span>
	<span class="n">nReduce</span>              <span class="kt">int</span>            <span class="c">// number of reduce tasks</span>
	<span class="n">nMap</span>                 <span class="kt">int</span>            <span class="c">// number of map tasks</span>
<span class="p">}</span>
</code></pre></div></div> <h4 id="done-function"> <strong>Done()</strong> function</h4> <p>This function performs the critical task of checking if assigned tasks by the Coordinator should be available for reassignment given they have been executing for longer than 10s. The original assignments are still allowed to respond, but if there are free Workers they can also perform these tasks.</p> <p>This function is called every second by <code class="language-plaintext highlighter-rouge">src/main/mrcoordinator.go</code> in the main thread.</p> <hr> <h3 id="workergo"><strong>worker.go</strong></h3> <p>The worker implementation contains the code for reading in files for the map and reduce functions. <strong>Worker()</strong> performs two loops: one to perform the mapping and storage of intermediates, and the other to read in the intermediates, perform the reduce task, and store the results. Both loops:</p> <ol> <li>Exit <ol> <li>if the reply from the Coordinator on request for a map/reduce task responds with 0 remaining tasks left</li> <li>if the Coordinator is unreachable.</li> </ol> </li> <li>Continue executing <ol> <li>if there is a task provided</li> <li>if there are tasks executing and not completed remaining <ol> <li>In this case, the Worker will sleep for 50 milliseconds to prevent repetitive polling of the Coordinator for work (this could be modified to use a Conditional variable in the Coordinator’s response)</li> </ol> </li> </ol> </li> </ol> <div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">mapTask</span><span class="p">(</span><span class="n">mapf</span> <span class="k">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">KeyValue</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="n">reply</span> <span class="o">:=</span> <span class="n">CallMapTask</span><span class="p">()</span>
	<span class="n">filename</span> <span class="o">:=</span> <span class="n">reply</span><span class="o">.</span><span class="n">Filename</span>
	<span class="c">// If provided a filename, proceed</span>
	<span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="s">""</span> <span class="p">{</span>
		<span class="c">//...</span>
		<span class="c">// store intermediates</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">CallStoreIntermediateFiles</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">TaskNumber</span><span class="p">,</span> <span class="n">intermediates</span><span class="p">)</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
			<span class="c">// Can't reach coordinator, exit</span>
			<span class="k">return</span> <span class="no">true</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">RemainingTasks</span> <span class="o">!=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">filename</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="c">// Remaining tasks are all being processed by other workers</span>
		<span class="c">// Stay on standby incase map tasks are freed</span>
		<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="m">50</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">RemainingTasks</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">false</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">reduceTask</span><span class="p">(</span><span class="n">reducef</span> <span class="k">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="n">reply</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">CallGetReduceTasks</span><span class="p">()</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
		<span class="c">// Can't reach Coordinator</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">RemainingTasks</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="c">// Done with all reduce tasks</span>
		<span class="k">return</span> <span class="no">true</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">TaskNumber</span> <span class="o">==</span> <span class="o">-</span><span class="m">1</span> <span class="p">{</span>
		<span class="c">// there are still reduce tasks remaining but all are assigned</span>
		<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="m">50</span><span class="p">)</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Millisecond</span><span class="p">)</span>
		<span class="k">return</span> <span class="no">false</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c">// read intermediary files (should be in sorted order)</span>
		<span class="c">//...</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">CallCompleteReduceTask</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">TaskNumber</span><span class="p">)</span> <span class="p">{</span>
			<span class="c">// Can't reach coordinator, exit</span>
			<span class="k">return</span> <span class="no">true</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">false</span>
<span class="p">}</span>

<span class="c">// main/mrworker.go calls this function.</span>
<span class="k">func</span> <span class="n">Worker</span><span class="p">(</span><span class="n">mapf</span> <span class="k">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">KeyValue</span><span class="p">,</span>
	<span class="n">reducef</span> <span class="k">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">mapTask</span><span class="p">(</span><span class="n">mapf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">reduceTask</span><span class="p">(</span><span class="n">reducef</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>To ensure fault-tolerance, Workers write to temporary files that only are renamed if</p> <ol> <li>the Coordinator receives the intermediates files from a mapping task</li> <li>the Worker completes writing reduce output and is considered complete if the Worker is able to communicate to the Coordinator to record completion</li> </ol> <p>These are to follow the specification mentioned in <strong>Section 3.2 - Semantics in the Presence of Failures</strong> of the original MapReduce paper.</p> <p>For the first case, waiting for the Coordinator to rename the files ensures that files exist and that only one Map task is considered by the Coordinator since the Coordinator will only consider it if it still believes the task has not been completed yet.</p> <p>The second case qualifies the condition of using the atomic rename function to ensure there is only one output per reduce task.</p> </article> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Daniel Chen. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: August 08, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-0P39TP2PFD"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0P39TP2PFD");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </div> </div> </body> </html>